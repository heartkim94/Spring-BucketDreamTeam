<?xml version="1.0" encoding="UTF-8"?>
<!-- mybatis map 선언 표시 -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
              "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 

<mapper namespace="com.pknu.project.group.dao.GroupDao">
	<select id="isAdminMember" parameterType="int" resultType="boolean">
		select	count(*)
		from	`group` g
		join	member m
		on		g.groupNum = m.groupNum
		where	g.groupNum = -1
				and userNum = #{userNum};
	</select>
	<select id="getMyGroup" parameterType="String" resultType="group">
		select	g.*, ifnull(cnt, 0) as memberCount
		from	`group` g
				 left join	member m	on g.groupNum = m.groupNum
				 left join	user u		on m.userNum = u.userNum
				 left join 	(select	groupNum, count(groupNum) as cnt
		           			from	member
		            		group by groupNum) c
		            					on g.groupNum = c.groupNum
		where 	u.id = #{id};
	</select>
	<select id="getCategory" resultType="category">
		SELECT c2.*
		FROM Category c1, category c2
		WHERE c1.parentNum=0
			  and (c1.catNum=c2.parentNum or c1.catNum=c2.catNum)
			  and c1.catNum!=-1
		ORDER BY c1.catNum, c2.parentNum;
	</select>
	<update id="newGroup" parameterType="group"
			useGeneratedKeys="true" keyColumn="groupNum" keyProperty="groupNum">
		INSERT INTO `Group`(groupName, groupOwner, catNum)
		VALUES(#{groupName},
			   (SELECT	userNum
			   FROM		User
			   WHERE	id=#{groupOwnerId}),
			   #{catNum}
		);
		INSERT INTO Member VALUES(
			last_insert_id(),
			(SELECT	userNum
			   FROM		User
			   WHERE	id=#{groupOwnerId})
		);
	</update>
</mapper>